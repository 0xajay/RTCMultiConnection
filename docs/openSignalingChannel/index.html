<!DOCTYPE html>
<html id="home" lang="en">

<head>
    <title>"RTCMultiConnection.openSignalingChannel" method</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="author" type="text/html" href="https://plus.google.com/+MuazKhan">
    <meta name="author" content="Muaz Khan">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <link rel="stylesheet" href="https://cdn.webrtc-experiment.com/style.css">
	
    <style>
            p { padding: .8em; }

            li {
                border-bottom: 1px solid rgb(189, 189, 189);
                border-left: 1px solid rgb(189, 189, 189);
                padding: .5em;
            }
			
			.image-container {
				text-align:center;
				margin: 2em 0;
			}
			
			.image-parent {
				margin: 0 2em;
				border: 2px solid black;
				border-radius: 5px;
			}
			
			.image-parent img {
				width: 100%;
			}
			
			li pre {
				margin: 0;
			}
        </style>
    <!-- for HTML5 el styling -->
    <script>
        document.createElement('article');
        document.createElement('footer');
    </script>
	
	<script src="https://cdn.webrtc-experiment.com/syntax/sh_main.min.js" type="text/javascript"> </script>
    <script src="https://cdn.webrtc-experiment.com/syntax/sh_javascript.min.js" type="text/javascript"> </script>
    <script src="https://cdn.webrtc-experiment.com/syntax/sh_html.min.js" type="text/javascript"> </script>
    <link href="https://cdn.webrtc-experiment.com/syntax/sh_style.css" type="text/css" rel="stylesheet">
</head>

<body onload="sh_highlightDocument();">
    <article>
        <a href="http://www.RTCMultiConnection.org/docs/" style="border-bottom: 1px solid #2844FA; font-size: 1.2em; position: absolute; text-decoration: none;right:0;top:0;">RTCMultiConnection Docs</a>

        <h1><a href="http://www.RTCMultiConnection.org/">RTCMultiConnection</a> API Reference / "<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a>" method</h1>
        
        <div class="github-stargazers"></div>
        
        <blockquote class="inline">
            "<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a>" is a simple "public" method which can be overwritten in any HTML page. This method is used to encapsulate all signaling stuff in single place.<br /><br />
            Whatever signaling mechanism exists there, whether it is XMPP or SIP, or 3rd party services as Pusher/Firebase/PubNub etc, each and every service can easily be used for signaling using <a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> method.<br /><br />
            Useful resources: <a href="https://github.com/muaz-khan/WebRTC-Experiment/blob/master/Signaling.md">https://github.com/muaz-khan/WebRTC-Experiment/blob/master/Signaling.md</a>
        </blockquote>
        
        <section class="experiment">
            <h2 id="video-presentation">
                <a href="#video-presentation">Quick Video Presentation</a>
            </h2>
            <iframe src="//player.vimeo.com/video/91780227" style="width: 100%;" height="460" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
            <a href="https://vimeo.com/channels/rtcmulticonnection">RTCMultiConnection Videos Channel</a>!
        </section>
        
        <section class="experiment">
            <h2 id="single-socket">
                <a href="#single-socket">Using Single Socket for Signaling</a>
            </h2>
            <pre class="sh_javascript">
var onMessageCallbacks = {};
var socket = io.connect('http://localhost:8888/');

socket.on('message', function(data) {
    if(data.sender == connection.<a href="http://www.RTCMultiConnection.org/docs/userid/"><code>userid</code></a>) return;

    if (onMessageCallbacks[data.channel]) {
        onMessageCallbacks[data.channel](data.message);
    };
});

connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    var channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
    onMessageCallbacks[channel] = config.onmessage;

    if (config.onopen) setTimeout(config.onopen, 1000);
    return {
        send: function (message) {
            socket.emit('message', {
                sender: connection.<a href="http://www.RTCMultiConnection.org/docs/userid/"><code>userid</code></a>,
                channel: channel,
                message: message
            });
        },
        channel: channel
    };
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="multiple-sockets">
                <a href="#multiple-sockets">Using Multiple Sockets for Signaling</a>
            </h2>
            <pre class="sh_javascript">
// Note: for a working demo, try next section.

connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
   var channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
   
   var socket = io.connect('/?channel=' + channel);
   socket.channel = channel;
   
   socket.on('connect', function () {
      if (config.callback) config.callback(socket);
   });
   
   socket.send = function (message) {
        socket.emit('message', {
            sender: connection.<a href="http://www.RTCMultiConnection.org/docs/userid/"><code>userid</code></a>,
            data  : message
        });
    };
   
   socket.on('message', config.onmessage);
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="socketio-signaling">
                <a href="#socketio-signaling">Using Socket.io for Signaling</a>
            </h2>
            <pre class="sh_javascript">
// http://socketio-over-nodejs.hp.af.cm/
// http://socketio-over-nodejs.jit.su:80/
// http://webrtc-signaling.jit.su:80/

var SIGNALING_SERVER = 'https://webrtc-signaling.nodejitsu.com/';
connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
   var channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
   var sender = Math.round(Math.random() * 9999999999) + 9999999999;

   io.connect(SIGNALING_SERVER).emit('new-channel', {
      channel: channel,
      sender : sender
   });

   var socket = io.connect(SIGNALING_SERVER + channel);
   socket.channel = channel;

   socket.on('connect', function () {
      if (config.callback) config.callback(socket);
   });

   socket.send = function (message) {
        socket.emit('message', {
            sender: sender,
            data  : message
        });
    };

   socket.on('message', config.onmessage);
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="websockets-signaling">
                <a href="#websockets-signaling">Using WebSockets for Signaling</a>
            </h2>
            <pre class="sh_javascript">
// wss://wsnodejs.nodejitsu.com:443 (Secure port: HTTPs)
// ws://wsnodejs.nodejitsu.com:80 (Ordinary port: HTTP)

var SIGNALING_SERVER = 'wss://wsnodejs.nodejitsu.com:443';
connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    config.channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
    var websocket = new WebSocket(SIGNALING_SERVER);
    websocket.channel = config.channel;
    websocket.onopen = function() {
        websocket.push(JSON.stringify({
            open: true,
            channel: config.channel
        }));
        if (config.callback)
            config.callback(websocket);
    };
    websocket.onmessage = function(event) {
        config.onmessage(JSON.parse(event.data));
    };
    websocket.push = websocket.send;
    websocket.send = function(data) {
        websocket.push(JSON.stringify({
            data: data,
            channel: config.channel
        }));
    };
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="firebase-signaling">
                <a href="#firebase-signaling">Using Firebase for Signaling</a>
            </h2>
            <pre class="sh_javascript">
connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    config.channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
    
    var socket = new Firebase('https://chat.firebaseIO.com/' + config.channel);
    socket.channel = config.channel;
    
    socket.on('child_added', function (data) {
        config.onmessage(data.val());
    });
    
    socket.send = function(data) {
        this.push(data);
    };
    
    config.onopen && setTimeout(config.onopen, 1);
    socket.onDisconnect().remove();
    return socket;
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="pubnub-signaling">
                <a href="#pubnub-signaling">Using PubNub for Signaling</a>
            </h2>
            <pre class="sh_javascript">
connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    config.channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
    var socket = io.connect('https://pubsub.pubnub.com/' + config.channel, {
        publish_key: 'demo',
        subscribe_key: 'demo',
        channel: config.channel,
        ssl: true
    });
    socket.channel = config.channel;
    if (config.onopen) socket.on('connect', config.onopen);
    socket.on('message', config.onmessage);
    return socket;
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="pusher-signaling">
                <a href="#pusher-signaling">Using Pusher for Signaling</a>
            </h2>
            <pre class="sh_javascript">
// below snippet is taken from: 
// <a href="http://pusher.com/tutorials/webrtc_chat">http://pusher.com/tutorials/webrtc_chat</a>

connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    config.channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
    var xhrErrorCount = 0;

    var socket = {
        send: function(message) {
            $.ajax({
                type: "POST",
                url: "/message",
                data: {
                    socketId: socketId,
                    channel: config.channel,
                    message: message
                },
                timeout: 1000,
                success: function(data) {
                    xhrErrorCount = 0;
                },
                error: function(xhr, type) {
                    // Increase XHR error count
                    xhrErrorCount++;

                    // Stop sending signaller messages if it's down
                    if (xhrErrorCount > 5) {
                        console.log("Disabling signaller due to connection failure");
                        connection.transmitRoomOnce = true;
                    }
                }
            });
        },
        channel: config.channel
    };

    // Subscribe to Pusher signalling channel
    var pusherChannel = pusher.subscribe(config.channel);

    // Call callback on successful connection to Pusher signalling channel
    pusherChannel.bind("pusher:subscription_succeeded", function() {
        if (config.callback) config.callback(socket);
    });

    // Proxy Pusher signaller messages to DataChannel
    pusherChannel.bind("message", function(message) {
        config.onmessage(message);
    });

    return socket;
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="websync-signaling">
                <a href="#websync-signaling">Using WebSync for Signaling</a>
            </h2>
            <pre class="sh_javascript">
// below snippet is taken from:
// <a href="https://github.com/muaz-khan/WebSync-Signaling">https://github.com/muaz-khan/WebSync-Signaling</a>

var channels = {};
var username = Math.round(Math.random() * 60535) + 5000;

var client = new fm.websync.client('websync.ashx');

client.setAutoDisconnect({
    synchronous: true
});

client.connect({
    onSuccess: function () {
        client.join({
            channel: '/chat',
            userId: username,
            userNickname: username,
            onReceive: function (event) {
                var message = JSON.parse(event.getData().text);
                if (channels[message.channel] && channels[message.channel].onmessage) {
                    channels[message.channel].onmessage(message.message);
                }
            }
        });
    }
});

connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    var channel = config.channel || this.channel;
    channels[channel] = config;

    if (config.onopen) setTimeout(config.onopen, 1000);
    return {
        send: function (message) {
            client.publish({
                channel: '/chat',
                data: {
                    username: username,
                    text: JSON.stringify({
                        message: message,
                        channel: channel
                    })
                }
            });
        }
    };
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="xhr-signaling">
                <a href="#xhr-signaling">Using XHR for Signaling</a>
            </h2>
            <pre class="sh_javascript">
// below snipet is taken from:
// <a href="https://github.com/muaz-khan/XHR-Signaling">https://github.com/muaz-khan/XHR-Signaling</a>

// database has a single table; which has two columns: 
// 1) Message (required to store JSON data)
// 2) ID (optional: as primary key)

// a simple function to make XMLHttpRequests
function xhr(url, callback, data) {
    if (!window.XMLHttpRequest || !window.JSON) return;

    var request = new XMLHttpRequest();
    request.onreadystatechange = function () {
        if (callback && request.readyState == 4 && request.status == 200) {
            // server MUST return JSON text
            callback(JSON.parse(request.responseText));
        }
    };
    request.open('POST', url);

    var formData = new FormData();

    // you're passing "message" parameter
    formData.append('message', data);

    request.send(formData);
}

// this object is used to store "onmessage" callbacks from "openSignalingChannel handler
var onMessageCallbacks = {};

// this object is used to make sure identical messages are not used multiple times
var messagesReceived = {};

function repeatedlyCheck() {
    xhr('/Home/GetData', function (data) {
        // if server says nothing; wait.
        if (data == false) return setTimeout(repeatedlyCheck, 400);

        // if already receied same message; skip.
        if (messagesReceived[data.ID]) return setTimeout(repeatedlyCheck, 400);
        messagesReceived[data.ID] = data.Message;

        // "Message" property is JSON-ified in "openSignalingChannel handler
        data = JSON.parse(data.Message);

        // don't pass self messages over "onmessage" handlers
        if (data.sender != connection.<a href="http://www.RTCMultiConnection.org/docs/userid/"><code>userid</code></a> && onMessageCallbacks[data.channel]) {
            onMessageCallbacks[data.channel](data.message);
        }

        // repeatedly check the database
        setTimeout(repeatedlyCheck, 1);
    });
}

repeatedlyCheck();

// overriding "openSignalingChannel handler
connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    var channel = config.<a href="http://www.RTCMultiConnection.org/docs/channel-id/"><code>channel</code></a> || this.channel;
    onMessageCallbacks[channel] = config.onmessage;

    // let RTCMultiConnection know that server connection is opened!
    if (config.onopen) setTimeout(config.onopen, 1);

    // returning an object to RTCMultiConnection
    // so it can send data using "send" method
    return {
        send: function (data) {
            data = {
                channel: channel,
                message: data,
                sender: connection.<a href="http://www.RTCMultiConnection.org/docs/userid/"><code>userid</code></a>
            };

            // posting data to server
            // data is also JSON-ified.
            xhr('/Home/PostData', null, JSON.stringify(data));
        },
        channel: channel
    };
};
</pre>
        </section>
        
        <section class="experiment">
            <h2 id="signalr-signaling">
                <a href="#signalr-signaling">Using SignalR for Signaling</a>
            </h2>
            <pre class="sh_javascript">
// below snippet is taken from:
// <a href="https://github.com/muaz-khan/WebRTC-Experiment/blob/master/Signaling.md#how-to-use-signalr-for-signaling">https://github.com/muaz-khan/WebRTC-Experiment/blob/master/Signaling.md#how-to-use-signalr-for-signaling</a>

var onMessageCallbacks = {};

var hub = $.connection.webRtcHub3;
$.support.cors = true;

$.connection.hub.url = '/signalr/hubs';

hub.client.onMessageReceived = function (message) {
    var message = JSON.parse(message);
    if (onMessageCallbacks[message.channel]) {
        onMessageCallbacks[message.channel](message.message);
    }
};

// start the hub
$.connection.hub.start();

connection.<a href="http://www.RTCMultiConnection.org/docs/openSignalingChannel/"><code>openSignalingChannel</code></a> = function (config) {
    config.channel = config.channel || this.channel;
    onMessageCallbacks[config.channel] = config.onmessage;

    if (config.onopen) setTimeout(config.onopen, 1000);
    return {
        send: function (message) {
            message = JSON.stringify({
                message: message,
                channel: config.channel
            });

            hub.server.send(message);
        }
    };
};
</pre>
        </section>
        
        <br />
        <section style="border: 1px solid rgb(189, 189, 189); margin: 1em 3em; border-radius: .2em;">
                <h2 id="feedback" style="padding: .2em .4em; border-bottom: 1px solid rgb(189, 189, 189);">Want to ask a Question?</h2>
                <div>
                    <textarea id="message" style="height: 8em; margin: .2em; width: 98%; border: 1px solid rgb(189, 189, 189); outline: none; resize: vertical;" placeholder="Feel free to ask any question regarding RTCMultiConnection.js!"></textarea>
                </div>
                <button id="send-message" style="font-size: 1em;">Ask a Question</button><small style="margin-left:1em;">You can include your email for private conversation!</small>
            </section>
            
            <section class="experiment own-widgets latest-commits">
                <h2 class="header" id="updates" style="color: red; padding-bottom: .1em;"><a href="https://github.com/muaz-khan/WebRTC-Experiment/commits/master" target="_blank">Latest Updates</a></h2>
                <div id="github-commits"></div>
            </section>
    </article>
    
    <a href="https://github.com/muaz-khan/WebRTC-Experiment/tree/master/RTCMultiConnection" class="fork-left"></a>
	
        <footer>
            <a href="https://www.webrtc-experiment.com/" target="_blank">WebRTC Experiments!</a> and 
            <a href="http://www.RTCMultiConnection.org/docs/" target="_blank">RTCMultiConnection.js</a> ©
            <a href="mailto:muazkh@gmail.com" target="_blank">Muaz Khan</a>:
            <a href="https://twitter.com/WebRTCWeb" target="_blank">@WebRTCWeb</a>
        </footer>
        
    <script src="//www.rtcmulticonnection.org/commits.js"> </script>
</body>
</html>